# 项目架构说明

## 项目结构

```
campus-club-manager-backend/
├── src/main/java/com/club/campusclubmanager/
│   ├── config/                    # 配置类
│   │   ├── MyBatisPlusConfig.java    # MyBatis Plus 配置（分页插件、自动填充）
│   │   └── SaTokenConfig.java        # Sa-Token 配置（拦截器、权限接口）
│   ├── controller/                # 控制器层
│   │   └── UserController.java       # 用户管理控制器
│   ├── dto/                       # 数据传输对象（请求参数）
│   │   ├── LoginRequest.java         # 登录请求
│   │   ├── RegisterRequest.java      # 注册请求
│   │   └── UpdateUserRequest.java    # 更新用户信息请求
│   ├── entity/                    # 实体类（数据库映射）
│   │   └── User.java                 # 用户实体
│   ├── enums/                     # 枚举类
│   │   └── UserRole.java             # 用户角色枚举
│   ├── exception/                 # 异常处理
│   │   ├── BusinessException.java    # 业务异常
│   │   └── GlobalExceptionHandler.java # 全局异常处理器
│   ├── mapper/                    # MyBatis Mapper
│   │   └── UserMapper.java           # 用户 Mapper
│   ├── service/                   # 服务接口
│   │   ├── UserService.java          # 用户服务接口
│   │   └── impl/
│   │       └── UserServiceImpl.java  # 用户服务实现
│   ├── vo/                        # 视图对象（响应数据）
│   │   ├── LoginResponse.java        # 登录响应
│   │   └── UserInfoVO.java           # 用户信息视图对象
│   ├── common/                    # 公共类
│   │   └── Result.java               # 统一响应结果
│   └── CampusClubManagerBackendApplication.java  # 启动类
├── src/main/resources/
│   ├── application.yaml           # 主配置文件
│   └── db/migration/              # 数据库迁移脚本
│       └── V1__Create_User_Table.sql
└── docs/                          # 文档目录
    ├── RBAC权限系统使用指南.md
    ├── 快速启动指南.md
    └── 项目架构说明.md
```

## 技术栈

### 核心框架

- **Spring Boot 3.4.4** - 应用框架
- **MyBatis Plus 3.5.9** - ORM 框架
- **Sa-Token 1.44.0** - 权限认证框架

### 数据库

- **MySQL 8.0+** - 关系型数据库
- **MySQL Connector/J** - JDBC 驱动

### 工具库

- **Lombok** - 简化代码
- **Validation** - 参数校验
- **SpringDoc OpenAPI** - API 文档（Swagger）

### 其他依赖

- **Aliyun OSS** - 对象存储（文件上传）
- **Jackson** - JSON 序列化

## 架构设计

### 分层架构

```
┌─────────────────────────────────────┐
│         Controller 层                │  ← HTTP 请求入口
│  - 参数校验（@Valid）                │
│  - 权限验证（@SaCheckRole）          │
│  - 返回统一响应（Result<T>）         │
└─────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────┐
│          Service 层                  │  ← 业务逻辑
│  - 业务规则实现                      │
│  - 事务管理                          │
│  - 异常处理                          │
└─────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────┐
│          Mapper 层                   │  ← 数据访问
│  - MyBatis Plus CRUD                │
│  - 自定义 SQL                        │
└─────────────────────────────────────┘
                 ↓
┌─────────────────────────────────────┐
│          Database                    │  ← 数据持久化
│  - MySQL 8.0                         │
└─────────────────────────────────────┘
```

### 请求处理流程

```
HTTP Request
    │
    ├─→ SaToken 拦截器（登录验证）
    │       │
    │       ├─ 检查 Token
    │       └─ 注入用户信息
    │
    ├─→ Controller（接收请求）
    │       │
    │       ├─ 参数校验（@Valid）
    │       ├─ 权限验证（@SaCheckRole）
    │       └─ 调用 Service
    │
    ├─→ Service（业务处理）
    │       │
    │       ├─ 业务逻辑
    │       ├─ 调用 Mapper
    │       └─ 返回结果
    │
    ├─→ GlobalExceptionHandler（异常处理）
    │       │
    │       ├─ 捕获异常
    │       └─ 返回错误响应
    │
    └─→ HTTP Response（统一格式）
            {
              "code": 200,
              "message": "操作成功",
              "data": {...}
            }
```

## 设计模式与原则

### 1. 依赖注入（DI）

使用 Spring 的依赖注入，通过构造器注入依赖：

```java
@RestController
@RequiredArgsConstructor  // Lombok 生成构造器
public class UserController {
    private final UserService userService;  // 自动注入
}
```

### 2. 面向接口编程

Service 层定义接口，方便后续扩展和测试：

```java
public interface UserService extends IService<User> {
    void register(RegisterRequest request);
    // ...
}

@Service
public class UserServiceImpl extends ServiceImpl<UserMapper, User> implements UserService {
    // 实现
}
```

### 3. DTO/VO 模式

- **DTO (Data Transfer Object)** - 用于接收客户端请求数据
- **VO (View Object)** - 用于返回给客户端的数据
- **Entity** - 数据库实体，不直接暴露给客户端

```
Client Request → DTO → Service → Entity → Database
Database → Entity → Service → VO → Client Response
```

### 4. 统一响应格式

所有接口返回统一的 `Result<T>` 格式：

```java
@Data
public class Result<T> {
    private Integer code;      // 状态码
    private String message;    // 响应消息
    private T data;           // 响应数据
}
```

### 5. 全局异常处理

使用 `@RestControllerAdvice` 统一处理异常：

```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    @ExceptionHandler(BusinessException.class)
    public Result<Void> handleBusinessException(BusinessException e) {
        return Result.fail(e.getCode(), e.getMessage());
    }
}
```

## RBAC 权限设计

### 核心组件

1. **UserRole 枚举** - 定义系统角色
2. **SaTokenConfig** - 实现 `StpInterface` 接口，提供角色查询
3. **@SaCheckRole 注解** - 在 Controller 方法上声明权限要求
4. **SaInterceptor 拦截器** - 自动验证用户登录状态

### 权限验证流程

```
1. 用户登录 → StpUtil.login(userId)
2. 生成 Token → StpUtil.getTokenValue()
3. 客户端携带 Token 访问接口
4. SaInterceptor 拦截器验证 Token
5. @SaCheckRole 注解验证角色
6. 通过验证 → 执行业务逻辑
7. 验证失败 → 抛出异常 → GlobalExceptionHandler 处理
```

## 数据库设计

### 用户表（user）

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| id | BIGINT | 用户ID | 主键，自增 |
| username | VARCHAR(50) | 用户名 | 唯一，非空 |
| password | VARCHAR(255) | 密码（加密） | 非空 |
| real_name | VARCHAR(50) | 真实姓名 | 非空 |
| student_id | VARCHAR(50) | 学号 | 唯一，非空 |
| email | VARCHAR(100) | 邮箱 | 唯一，非空 |
| phone | VARCHAR(20) | 手机号 | - |
| avatar | VARCHAR(500) | 头像URL | - |
| role | VARCHAR(20) | 用户角色 | 非空，默认 'user' |
| status | TINYINT | 账户状态 | 非空，默认 1 |
| create_time | DATETIME | 创建时间 | 自动填充 |
| update_time | DATETIME | 更新时间 | 自动更新 |
| is_deleted | TINYINT | 逻辑删除 | 默认 0 |

### 索引设计

- **主键索引**：`id`
- **唯一索引**：`username`, `student_id`, `email`
- **普通索引**：`role`, `status`

## 配置说明

### application.yaml 核心配置

```yaml
# 服务器配置
server:
  port: 8080
  servlet:
    context-path: /api  # 所有接口统一前缀

# MyBatis Plus 配置
mybatis-plus:
  configuration:
    map-underscore-to-camel-case: true  # 下划线转驼峰
    log-impl: org.apache.ibatis.logging.stdout.StdOutImpl  # SQL 日志
  global-config:
    db-config:
      logic-delete-field: is_deleted  # 逻辑删除字段
      logic-delete-value: 1
      logic-not-delete-value: 0

# Sa-Token 配置
sa-token:
  token-name: Authorization  # Token 名称
  token-prefix: Bearer       # Token 前缀
  timeout: 2592000          # Token 有效期（30天）
  is-concurrent: true       # 允许并发登录
```

## 安全设计

### 1. 密码加密

```java
// MD5 + 盐值加密
private String encryptPassword(String password) {
    return DigestUtils.md5DigestAsHex(
        (password + SALT).getBytes(StandardCharsets.UTF_8)
    );
}
```

### 2. 参数校验

使用 Bean Validation 注解：

```java
@Data
public class RegisterRequest {
    @NotBlank(message = "用户名不能为空")
    @Pattern(regexp = "^[a-zA-Z0-9_]{4,20}$")
    private String username;

    @NotBlank(message = "密码不能为空")
    @Pattern(regexp = "^.{6,20}$")
    private String password;
}
```

### 3. SQL 注入防护

使用 MyBatis Plus 的参数化查询，自动防止 SQL 注入。

### 4. Token 安全

- Token 存储在内存（不持久化）
- 支持 Token 刷新
- 支持主动踢人下线

## 扩展性设计

### 1. 易于添加新角色

在 `UserRole` 枚举中添加新值即可：

```java
public enum UserRole {
    USER("user", "普通用户"),
    CLUB_ADMIN("club_admin", "社团管理员"),
    SYSTEM_ADMIN("system_admin", "系统管理员"),
    NEW_ROLE("new_role", "新角色");  // 新增
}
```

### 2. 易于添加细粒度权限

修改 `SaTokenConfig.getPermissionList()` 方法：

```java
@Override
public List<String> getPermissionList(Object loginId, String loginType) {
    // 从数据库或缓存查询用户权限
    return permissionService.getByUserId((Long) loginId);
}
```

### 3. 易于切换缓存

Sa-Token 支持多种缓存实现：

```xml
<!-- Redis 缓存 -->
<dependency>
    <groupId>cn.dev33</groupId>
    <artifactId>sa-token-redis-jackson</artifactId>
</dependency>
```

## 性能优化建议

1. **添加 Redis 缓存** - 缓存用户角色和权限
2. **数据库连接池** - 配置 HikariCP 参数
3. **分页查询** - 使用 MyBatis Plus 分页插件
4. **异步处理** - 对于耗时操作使用 `@Async`
5. **索引优化** - 为常用查询字段添加索引

## 监控与日志

### 日志配置

```yaml
logging:
  level:
    root: INFO
    com.club.campusclubmanager: DEBUG  # 项目日志级别
```

### 推荐添加

- **Spring Boot Actuator** - 健康检查
- **Micrometer** - 监控指标
- **ELK Stack** - 日志收集分析
